<dashboard version="1.1">
  <label>Getting started</label>
  <row>
    <panel>
      <html>
<style>
.images {
  display: block;
  margin-left: auto;
  margin-right: auto;
  width: 40%;
}
</style>

<h1>Index</h1>
<ol>
<li><a href="#importdata">Importing ADTimeline data in Splunk</a></li>  
<li><a href="#scrtype">Source types and extracted fields</a>  
<ul>
<li><a href="#srcadt">The adtimeline source type</a></li>   
<li><a href="#srcado">The adobjects source type</a></li>
<li><a href="#srcgco">The gcobjects source type</a></li>
</ul>
</li>
<li><a href="#adginfo">AD General information dashboards</a>
<ul>
<li><a href="#adinfra">Active Directory Infrastructure dashboard</a></li>   
<li><a href="#saccounts">Sensitive accounts dashboard</a></li>
</ul>
</li> 
<li><a href="#adth">AD threat hunting dashboards</a>
<ul>
<li><a href="#intf">Investigate timeframe dashboard</a></li>   
<li><a href="#tsad">Track suspicious activity dashboard</a></li>
<li><a href="#tsexch">Track suspicious Exchange activity dashboard</a></li>
</ul>
</li> 
<li><a href="#etth">Enhance your traditional event logs threat hunting with ADTimeline</a></li> 
</ol>


<h1 id="importdata">Importing ADTimeline data in Splunk</h1>
<p>The ADTimeline script generates a timeline based on Active Directory replication metadata for objects considered of interest. Replication metadata gives you the time at which each replicated attribute for a given object was last changed. As a result, the timeline of modifications is partial. In order to be able to process this data with Splunk run the ADTimeline PowerShell script against your Active Directory domain as described on the <a href="https://github.com/ANSSI-FR/ADTimeline/blob/master/README.md">project homepage</a>.</p>
<p>After processing the ADTimeline script you should have two or three files to import in Splunk (<i>%DOMAINFQDN%</i> is the Active Directory fully qualified domain name):
<ul>
<li><i>timeline_%DOMAINFQDN%.csv</i>: The timeline generated with the AD replication metadata of objects retrieved. The corresponding source type is <i>adtimeline</i></li>
<li><i>ADobjects_%DOMAINFQDN%.xml</i>: Objects of interest retrieved via LDAP. The corresponding sourcetype is <i>adobjects</i></li>
<li><i>gcADobjects_%DOMAINFQDN%.xml</i>: If any, objects of interest retrieved via the Global Catalog. The corresponding source type is <i>gcobjects</i></li>
</ul>
</p>
<p>
You can import the data in an existing index with other source types (e.g. Windows event logs) or create a dedicated one. Navigate to the <i>"add data"</i> page and select <i>"upload files from my computer"</i>:
</p>
<div class="images">
          <img src="/static/app/SA-ADTimeline/images/tuto1.png"/>
</div>

<p>
Select the file you wish to upload: <i>timeline_%DOMAINFQDN%.csv</i>, <i>ADobjects_%DOMAINFQDN%.xml</i> or <i>gcADobjects_%DOMAINFQDN%.xml</i>:
</p>
<div class="images">
          <img src="/static/app/SA-ADTimeline/images/tuto2.png"/>
</div>
<p>
Select the appropriate source type: 
<ul>
<li><i>Adtimeline</i> source type for the file <i>timeline_%DOMAINFQDN%.csv</i></li>
<li><i>Adobjects</i> source type for the file <i>ADobjects_%DOMAINFQDN%.xml</i></li>
<li><i>Gcobjects</i> source type for the file <i>gcADobjects_%DOMAINFQDN%.xml</i> if the file exists</li>
</ul>
</p>
<div class="images">
          <img src="/static/app/SA-ADTimeline/images/tuto3.png"/>
</div>
<p>
The host field value should be the same for each file and match the Active Directory fully qualified domain name (<i>%DOMAINFQDN%</i>), after select the desired index:
</p>
<div class="images">
          <img src="/static/app/SA-ADTimeline/images/tuto4.png"/>
</div>
<p>
Review your settings before import and repeat the above steps for each file generated by the ADTimeline script. If you ran the script against many Active Directory domains, repeat also the same steps, just change the host field value accordingly. 
</p>
<div class="images">
          <img src="/static/app/SA-ADTimeline/images/tuto5.png"/>
</div>

<h1 id="scrtype">Source types and extracted fields</h1>
<u><h2 id="srcadt">The adtimeline source type</h2></u>
<p>
The <i>adtimeline</i> source type is the data from the <i>timeline_%DOMAINFQDN%.csv</i> file, which is the Active Directory timeline built with replication metadata for objects considered of interest.
</p>
<p>
The timestamp value is the <i>ftimeLastOriginatingChange</i> value of the replication metadata, which is the time the attribute was last changed, time is UTC.
</p>
<p>
The extracted fields are:
<ul>
<li><i>Name</i>: LDAP object name.</li>
<li><i>pszAttributeName</i>: The attribute name.</li>
<li><i>dwVersion</i>: Counter incremented every time the attribute is changed.</li>
<li><i>DN</i>: LDAP object DistinguishedName.</li>
<li><i>WhenCreated</i>: LDAP object creation time.</li>
<li><i>ObjectClass</i> and <i>ObjectCategory</i>: LDAP object type (user, computer, group...)</li>
<li><i>SamAccountName</i> and <i>SID</i>: Account Name and security identifier, only applies to users, computers and groups.</li>
<li><i>usnOriginatingChange</i>: USN on the originating server at which the last change to this attribute was made.</li>
<li><i>pszLastOriginatingDsaDN</i>: DC on which the last change was made to this attribute.</li> 
<li><i>uuidLastOriginatingDsaInvocationID</i>: ID corresponding to the <i>pszLastOriginatingDsaDN</i>.</li>
<li><i>usnLocalChange</i>: USN on the destination server (the server your LDAP bind is made) at which the last change to this attribute was applied.</li>
<li><i>Member</i>: Only applies to the group <i>ObjectClass</i> and when the attribute name is member. Contains the value of the group member DistinguishedName.</li>
<li><i>ftimeCreated</i>: Only applies to group <i>ObjectClass</i> and when the attribute name is member. Contains the time the member was added in the group.</li>
<li><i>ftimeDeleted</i>: Only applies to group <i>ObjectClass</i> and when the attribute name is member. Contains the time the member was removed from the group.</li>
</ul>
</p>

<u><h2 id="srcado">The adobjects source type</h2></u>
<p>
The <i>adobjects</i> source type is the data from the <i>ADobjects_%DOMAINFQDN%.xml</i> file, which is an export of the Active Directory objects considered of interested and retrieved via the LDAP protocol.
</p>
<p>
The timestamp value is the <i>createTimeStamp</i> attribute value, time zone is specified in the attribute value.
</p>
<p>
The extracted fields are:
<ul>
<li><i>Name</i>: LDAP object name.</li>
<li><i>DN</i>: LDAP object DistinguishedName.</li>
<li><i>DisplayName</i>: LDAP object displayname.</li>
<li><i>WhenCreated</i>: LDAP object creation time.</li>
<li><i>ObjectClass</i> and <i>ObjectCategory</i>: LDAP object type (user, computer, group...)</li>
<li><i>SamAccountName</i> and <i>SID</i>: Account Name and security identifier, only applies to users, computers and groups.</li>
<li><i>Members</i> and <i>MemberOf</i>: Members of a group <i>ObjectClass</i> can be users, computers or groups and its linked attribute MemberOf which applies to groups, users and computers.</li>
<li><i>Owner</i>, <i>AccessToString</i> and <i>SDDL</i>: Are values computed from the <i>nTSecurityDescriptor</i> attribute</li>
<li><i>adminCount</i>: Privileged accounts protected by the SDProp process.</li>
<li><i>userAccountControl</i>:  Attribute which contains a range of flags which define some important basic properties of a computer or user object.</li>
<li><i>lastLogonTimestamp</i>: This attribute is not updated with all logon types or at every logon but is replicated and gives you an idea of wether a user or computer account has recently logged on to the domain.</li>
<li><i>dNSHostName</i>: DNS hostname attribute of a computer account.</li>
<li><i>SPNs</i>: List of Service Principal Names of a computer or user account.</li>
</ul>
</p>

<u><h2 id="srcgco">The gcobjects source type</h2></u>
<p>
The <i>gcobjects</i> source type is the data from the <i>gcADobjects_%DOMAINFQDN%.xml</i> file, which is an export of the Active Directory objects within the forest but outside the current domain and considered of interested, those objects are retrieved via the Global Catalog protocol.
</p>
<p>
The timestamp value is the <i>WhenCreated</i> attribute value, time zone is UTC.
</p>
<p>
The extracted fields are:
<ul>
<li><i>Name</i>: LDAP object name.</li>
<li><i>DN</i>: LDAP object DistinguishedName.</li>
<li><i>DisplayName</i>: LDAP object displayname.</li>
<li><i>WhenCreated</i>: LDAP object creation time.</li>
<li><i>ObjectClass</i> and <i>ObjectCategory</i>: LDAP object type (user, computer, group...)</li>
<li><i>SamAccountName</i> and <i>SID</i>: Account Name and security identifier, only applies to users, computers and groups.</li>
<li><i>userAccountControl</i>:  Attribute which contains a range of flags which define some important basic properties of a computer or user object.</li>
<li><i>lastLogonTimestamp</i>: This attribute is not updated with all logon types or at every logon but is replicated and gives you an idea if a user or computer account has recently logged onto the domain.</li>
<li><i>dNSHostName</i>: DNS hostname attribute of a computer account.</li>
<li><i>SPNs</i>: List of Service Principal Names of a computer or user account.</li>
</ul>
</p>

<h1 id="adginfo">AD General information dashboards</h1>
<u><h2 id="adinfra">Active Directory Infrastructure dashboard</h2></u>
<p>This dashboard analyses Adtimeline data in order to create some panels giving you information on the Windows domain infrastructure. Select the appropriate Index and Active Directory domain you wish to analyze:</p>
<div class="images">
          <img src="/static/app/SA-ADTimeline/images/tuto6.png"/>
</div>
<p>
The different panels are:
<ul>
<li><i>General information</i>: Information about the Schema version and functional levels. Depending on the result some AD security features may or may not be available. The Domain Controllers are also listed in this panel</li>
<li><i>Microsoft infrastructure products</i>: Tells you if some important Microsoft Infrastructure components such as Exchange on premises, Active Directory Federation Services or Active Directory Certificate Services are installed. Please consider monitoring events related to those services (<i>MSExchange CmdletLogs</i>, <i>ADFS auditing</i>...) </li>
<li><i>Domain Trusts</i>: List domain trusts by type and direction. Run ADTimeline on all your trusted domains, but most importantly make sure they are audited, monitored and secured as rigorously as the domain you are analyzing.</li>
<li><i>ADDS security features</i>: Tells you if some security features are enabled or not. First feature is the AD Recycle bin which gives the administrator the ability to easily recover deleted objects, it will also change the time after an object is removed from the AD database after deletion. Second feature tells you if the schema extension for the Local Admin Password Solution was performed, if yes sysadmins can enable password randomization for local administrators accounts in order to mitigate lateral movement. Another feature is authentication silos which can help to restrict privileged user account logons in order to mitigate privilege escalation by implementing a tiered administrative model. The last feature is the <i>Protected Users</i> group, with a DFL 2012R2 or more the members of this group receive some additional hardening </li>
<li><i>Service Connection Points</i>: Inventory of serviceConnectionPoint (SCP) object class. SCP make it easy for a service to publish service-specific data in the directory. Clients of the service use the data in an SCP to locate an instance of the service. Infrastructure assets such as RDS Gateway, SCCM, VMWare Vcenter, some Backup solutions publish an SCP in the directory. </li>
<li><i>Active Directory infrastructure timeline</i>: Displays a timeline of the infrastructure changes listed above. This timeline tells you the story of the evolution of your infrastructure.</li>
</ul>
</p>
<u><h2 id="saccounts">Sensitive accounts dashboard</h2></u>
<p>This dashboard provides an inventory of the privileged accounts in the domain and accounts prone to common attack scenarios due to their configuration. Select the appropriate index and the Active Directory domain you wish to analyze:</p>
<div class="images">
          <img src="/static/app/SA-ADTimeline/images/tuto7.png"/>
</div>
<p>
The different panels are:
<ul>
<li><i>Admin Accounts</i>: This panel lists the accounts where the <i>Admincount</i> attribute value equals 1. Those accounts have their ACL protected by the <i>SDProp</i> process and it means the account has or had at some point high privileges in Active Directory. The first table lists them and provides some information about the accounts, the second table displays a timeline of modifications for some attributes of these accounts.</li>
<li><i>Accounts sensitive to Kerberoast attacks</i>: <i>Kerberoasting</i> is an attack method that allows an attacker to crack the passwords of service accounts in Active Directory offline. The chart is a ratio of accounts prone to this attack and whether or not they are privileged accounts. The table lists them and provides some information about the accounts. Use least privilege principle for those accounts and consider using <i>Group Managed Service Accounts.</i></li>
<li><i>Accounts sensitive to AS-REP Roast attacks</i>: <i>AS-REP Roast</i> is an attack method that allows an attacker to crack the passwords of accounts in Active Directory offline. The chart is a ratio of accounts prone to this attack and whether or not they are privileged accounts. The table lists them and provides some information about the accounts. Use least privilege principle for those accounts.</li>
<li><i>Sensitive default accounts</i>: Some general information about the default <i>administrator</i>, <i>guest</i> and <i>krbtgt</i> accounts. <i>Administrator</i> can be disabled or renamed as a measure against account lockout. <i>Guest</i> account must be disabled and <i>krbtgt</i> password should be changed on a regular schedule.</li>
<li><i>Accounts trusted for delegation</i>: Kerberos Delegation is a feature that allows an application to reuse the end-user credentials to access resources hosted on a different server. An account trusted for unconstrained delegation is allowed to impersonate almost any user to any service within the network, whereas an account trusted for constrained delegation is allowed to impersonate almost any user for a given service within the network. The chart is a ratio of accounts trusted for constrained/unconstrained delegation. The tables list those accounts, the service name is given for accounts trusted for constrained delegation. A table listing objects with resource based constrained delegation configured is also displayed</li> 
</ul>
</p>

<h1 id="adth">AD threat hunting dashboards</h1>
<u><h2 id="intf">Investigate timeframe dashboard</h2></u>
<p>Use this dashboard to investigate a particular timeframe. Select the appropriate index, the Active Directory domain you wish to analyze and finally the timeframe you wish to investigate:</p>
<div class="images">
          <img src="/static/app/SA-ADTimeline/images/tuto8.png"/>
</div>
<p>
The different panels are:
<ul>
<li><i>AD Timeline</i>: A table displaying the timeline for the given timeframe.</li>
<li><i>Global stats</i>: Global statistics on modifications occurring during the given timeframe, including modifications by <i>ObjectClass</i>, by <i>pszAttributeName</i>, by Originating DC, by time (i.e. day of the week or hour of the day) and finally stats on deletions by <i>ObjectClass</i>.</li>
<li><i>Items created and deleted within timeframe</i>: A table displaying the creations and deletions of the same object within the given timeframe. A first chart gives you stats about object lifetimes in hours and a second one figures by <i>ObjectClass</i>.</li>
<li><i>Objects added or removed from groups or ACL modifications within timeframe</i>: This table focuses on the <i>Member</i> and <i>nTSecurityDescriptor</i> attributes, which can help detect an elevation of privilege for a specific account or a backdoor setup by the attacker, the <i>DistinguishedName</i> value of the member and the time the member was added or removed from the group is given in that table. Which makes it more detailed than the above AD Timeline panel. A chart displaying <i>nTSecurityDescriptor</i> modifications by <i>ObjectClass</i> and another displaying the number of times an object was added or removed from a group are given</li>
<li><i>GPOs modifications within timeframe</i>: A GPO can used by an attacker in various ways, for example to inject malicious code in logon/startup scripts, deploy malware at scale with an immediate scheduled task, setup a backdoor by modifying the <i>nTSecurityDescriptor</i>... For each attribute modification this table gives you the current <i>client side extensions</i> of the GPO and where the object is linked (OU, site or domain root).</li>
</ul>
</p>
<u><h2 id="tsad">Track suspicious activity dashboard</h2></u>
<p>This dashboard analyses the Active Directory timeline and highlights some modifications which can be a sign of a suspicious activity, the modifications spotted can also be legitimate and need a triage analysis. Select the appropriate index and the Active Directory domain you wish to analyze:</p>
<div class="images">
          <img src="/static/app/SA-ADTimeline/images/tuto9.png"/>
</div>
<p>
The different panels are:
<ul>
<li><i>ACL modifications</i>: This panel does not replace a thorough analysis of the Active Directory permissions with tools such as <i><a href="https://github.com/ANSSI-FR/AD-control-paths">AD Control Paths</a></i>. The panel contains a graph displaying a weekly timeline of ACL modifications per <i>ObjectClass</i> which occured one year back, some tables are focusing on the <i>domain root</i> and <i>AdminSDHolder</i> objects where permissions can be used as backdoor by an attacker. Finally, some statistics by <i>ObjectClass</i> and by least frequent owners are displayed.</li>
<li><i>Accounts</i>: This panel show account modifications which can a be sign of suspicious activity such as users added and removed from groups, some charts provide stats by number of times the account was added or removed, membership time in days, Organizational unit where accounts are located (an account from the "non_privileged_users" OU added and removed from a privileged group can be a sign of suspicious activity). There are some graphs, the first graph shows a timeline of accounts lockouts in order to highlight brute force attacks, the second graph shows SID history editions which can be suspicious outside a domain migration period, the next graph analyses all the different attributes modified on an account during a password change (<i>supplementalCredentials</i>, <i>lmPwdHistory</i>, <i>unicodePwd</i>...) and checks they are modified at the same time. A table displays resource based constrained delegation setup on privileged account or domain controller computer objects, which can be a backdoor setup by an attacker. Finally a chart displays domain controller computer objects password change frequency, an attacker could modify the DC registry to disable computer password change and use this password as a backdoor.</li>
<li><i>GPOs</i>: A table of GPOs modifications having an audit client side extension is displayed, an attacker could change the audit settings on the domain to perform malicious actions with stealth. Finally modifications which could result in a GPO processing malfunctioning are displayed, this includes <i>gPCFunctionalityVersion</i>, <i>gPCFileSysPath</i> or <i>versionNumber</i> attribute modification.</li>
<li><i>DCshadow detection</i>: The <i>DCshadow</i> is an attack which allows an attacker to push modifications in Active Directory and bypass traditional alerting by installing a fake DC. It was first presented by Vincent Le Toux and Benjamin Delpy at the BlueHat IL 2018 conference. The first graph will try to detect the installation of the fake DC by analyzing <i>server</i> and <i>nTDSDSA ObjectClass</i>. The two following tables will try to detect replication metadata tampering by analyzing <i>usnOriginatingChange</i> and <i>usnLocalChange</i> values which should increment through the time.</li>
<li><i>Schema and configuration partition suspicious modifications</i>: The first graph displays Active Directory attribute modifications related to the configuration and schema partitions which can lower the security of the domain, used as backdoor by an attacker or hide information to the security team. The second graph is relevant if you have Exchange on premises and track modifications in the configuration partition which can be a sign of mail exfiltration.</li>
</ul>
</p>
<u><h2 id="tsexch">Track suspicious Exchange activity dashboard</h2></u>
<p>This dashboard analyses your Exchange onprem Active Directory objects and highlights some modifications which can be a sign of a suspicious activity, the modifications spotted can also be legitimate and need a triage analysis.</p>
<div class="images">
          <img src="/static/app/SA-ADTimeline/images/tuto11.png"/>
</div>
<p>
The different panels are:
<ul>
<li><i>Microsoft Exchange infrastructure:</i>: Exchange version and servers.</li>
<li><i>Possible mail exfiltration</i>: Mail forwarders setup on mailboxes, transport rules, remote domains, maibox export requests, content searches...</li>
<li><i>Persistence</i>: RBAC roles and ACL modifications on Exchange objects.</li>
<li><i>MsExchangeSecurityGroups:</i>: Timeline and group membership of builtin Exchange security groups.</li>
<li><i>Phishing:</i>:Modifications on transport rules related to SCL and disclaimer.</li>
</ul>
</p>
<h1 id="etth">Enhance your traditional event logs threat hunting with ADTimeline</h1>
<p>The <i>adobjects</i> sourcetype is a set of data which can be used to uncover suspicious activity by performing Active Directory educated queries on the Windows event logs. We assume the sourcetype used for event logs is called <i>winevent</i> and its <i>EventData</i> part has the correct field extraction applied (ex EventID 4624 has among other fields <i>TargetUserName</i> and <i>TargetUserSid</i> extracted):
<div class="images">
          <img src="/static/app/SA-ADTimeline/images/tuto10.png"/>
</div>

</p>
<p>
You can perfrom similar queries with the <i><a href="https://docs.splunk.com/Documentation/MSApp/2.0.0/Reference/Aboutthismanual">Splunk App for Windows Infrastructure</a></i> and the <i><a href="https://docs.splunk.com/Documentation/SA-LdapSearch/3.0.0/User/AbouttheSplunkSupportingAdd-onforActiveDirectory">Splunk Supporting Add-on for Active Directory</a></i>. Here are some queries using ADTimeline data and Windows event logs which can help with your threat hunt.
</p>
<p>
Statistics on privileged accounts logons: 
<pre><code>index="*" sourcetype="winevent" EventID="4624" Channel="Security" 
[search index="*" sourcetype=adobjects  ((ObjectClass = "user" OR ObjectClass = "inetOrgPerson") AND adminCount=1) earliest = 1 latest = now() | rename SID as TargetUserSid | fields TargetUserSid] 
| strcat TargetDomainName "\\" TargetUserName TargetFullName | stats values(TargetFullName) as TargetFullName , values(LogonType) as logonTypes, values(IpAddress) as IpAdresses, values(Computer) as Computers, dc(Computer) as CountComputers, dc(IpAddress) as CountIpAdresses by TargetUserSid</code></pre>
</p>
Get processes running under a privileged account:
<pre><code>index="*" sourcetype="winevent" EventID="4688" Channel="Security" 
[search index="*" sourcetype=adobjects  ((ObjectClass = "user" OR ObjectClass = "inetOrgPerson") AND adminCount=1) earliest = 1 latest = now() | rename SamAccountName as TargetUserName | fields TargetUserName] 
OR [search index="*" sourcetype=adobjects  ((ObjectClass = "user" OR ObjectClass = "inetOrgPerson") AND adminCount=1) earliest = 1 latest = now() | rename SID as SubjectUserSid | fields SubjectUserSid] 
|  stats values(CommandLine) by Computer, TargetUserName,SubjectUserName</code></pre>
Get all privileged accounts PowerShell activity eventlogs:
<pre><code>index="*" sourcetype="winevent" Channel="*PowerShell*"  
[search index="*" sourcetype=adobjects  ((ObjectClass = "user" OR ObjectClass = "inetOrgPerson") AND adminCount=1) earliest = 1 latest = now() | dedup SamAccountName | return 1000 $SamAccountName]</code></pre>
Detect Kerberoasting possible activity:
<pre><code>index="*" sourcetype="winevent" Channel="Security" EventID="4769" 
[search index="*" sourcetype=adobjects (ObjectClass = "user" OR ObjectClass = "inetOrgPerson") AND (SPNs=* AND NOT Name=krbtgt) earliest = 1 latest = now() | rename SID as ServiceSid | fields ServiceSid] 
| strcat TargetDomainName "\\" TargetUserName TargetFullName  
|  eval time=strftime(_time,"%Y-%m-%d %H:%M:%S") 
|  stats list(ServiceName) as Services, distinct_count(ServiceName) as nbServices, list(time) as time by IpAddress, TicketEncryptionType 
| sort -nbServices</code></pre>
Detect abnormal processes running under Kerberoastable accounts:
<pre><code>index="*" sourcetype="winevent" Channel="Security" EventID="4688" 
[search index="*" sourcetype=adobjects  (ObjectClass = "user" OR ObjectClass = "inetOrgPerson") AND (SPNs=* AND NOT Name=krbtgt)  earliest = 1 latest = now()   | rename SamAccountName as TargetUserName | fields TargetUserName ] 
OR  [search index="*" sourcetype=adobjects  (ObjectClass = "user" OR ObjectClass = "inetOrgPerson") AND (SPNs=* AND NOT Name=krbtgt)  earliest = 1 latest = now()   | rename SID as SubjectUserSid | fields SubjectUserSid ] 
|  stats values(CommandLine) as cmdlines, values(TargetUserName) as TargetSubjectNames, values(SubjectUserName) as SubjectUserNames by Computer</code></pre>
Detect abnormal Kerberoastable user account logons:
<pre><code>index="*" sourcetype="winevent" Channel="Security" EventID="4624" 
[search index="*" sourcetype=adobjects   (ObjectClass = "user" OR ObjectClass = "inetOrgPerson") AND (SPNs=* AND NOT Name=krbtgt)  earliest = 1 latest = now() | rename SID as TargetUserSid  | fields TargetUserSid] 
| strcat TargetDomainName "\\" TargetUserName TargetFullName | stats values(TargetFullName) as TargetFullNames, values(IpAddress) as IpAddresses by LogonType, Computer</code></pre>
Detect abnormal AS-REP roastable user account logons:
<pre><code>index="*" sourcetype="winevent" Channel="Security" EventID="4624" 
[search index="*" sourcetype=adobjects (ObjectClass = "user" OR ObjectClass = "inetOrgPerson") earliest = 1 latest = now() |  eval eval_asrep_bit = floor(userAccountControl / pow(2, 22)) %2 | search eval_asrep_bit = 1 |  rename SID as TargetUserSid  | fields TargetUserSid]  
| strcat TargetDomainName "\\" TargetUserName TargetFullName | stats values(TargetFullName) as TargetFullNames, values(IpAddress) as IpAddresses by LogonType, Computer</code></pre>
Privileged accounts with flag "cannot be delegated" not set authenticating against computer configured for unconstrained delegation:
<pre><code>index="*" sourcetype="winevent" EventID="4624" Channel="Security" 
[search index="*" sourcetype=adobjects ObjectClass = "Computer" earliest = 1 latest = now() | eval eval_deleg_bit = floor(userAccountControl / pow(2, 19)) %2  | search  eval_deleg_bit = 1 | eval eval_dc_bit = floor(userAccountControl / pow(2, 13)) %2 |  eval eval_rodc_bit = floor(userAccountControl / pow(2, 26)) %2 | search eval_dc_bit = 0 AND eval_rodc_bit = 0 |   rename dNSHostName as Computer | fields Computer] 
|  search *   [search index="*" sourcetype=adobjects  ((ObjectClass = "user" OR ObjectClass = "inetOrgPerson") AND adminCount=1) earliest = 1 latest = now() | eval canbedelagated = round(((userAccountControl / pow(2, 20)) %2), 0) | search canbedelagated = 0 | rename SID as TargetUserSid  | fields TargetUserSid ] 
|  strcat TargetDomainName "\\" TargetUserName TargetFullName 
| table  _time, Computer, TargetFullName, IpAddress, LogonType, LogonProcessName</code></pre>
Detect possible printer bug triggering:
<pre><code>index="*" sourcetype="winevent" EventID="4624" Channel="Security" TargetUserName = "*$" NOT TargetUserSid="S-1-5-18"
[search index="*" sourcetype=adobjects ObjectClass = "Computer"  earliest = 1 latest = now() |  eval eval_deleg_bit = floor(userAccountControl / pow(2, 19)) %2  | search  eval_deleg_bit = 1 | eval eval_dc_bit = floor(userAccountControl / pow(2, 13)) %2 |  eval eval_rodc_bit = floor(userAccountControl / pow(2, 26)) %2 | search eval_dc_bit = 0 AND eval_rodc_bit = 0  |  rename dNSHostName as Computer | fields Computer]
| strcat TargetDomainName "\\" TargetUserName TargetFullName | stats values(LogonType), values(IpAddress), values(LogonProcessName) count by Computer, TargetFullName</code></pre>

      </html>
    </panel>
  </row>
</dashboard>